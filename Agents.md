# 対応言語
コメント及び回答は日本語を使う

# 🤖 Agents 連携ガイド

## 目的
AIエージェントやRPAフローなどの自動化ワークロードから、FastAPI ベースの YOLO 物体検出 API を安全かつ安定的に呼び出すための指針をまとめています。

## 想定シナリオ
- 画像を取り扱うチャットボットが、ユーザー投稿画像の内容を解析したいとき
- 監視カメラやドローン映像を扱うエージェントが、検出メタデータを別システムへ送信するとき
- ノーコード/ローコードツールで構築した自動化シナリオに物体検出機能を組み込みたいとき

## システム構成（概要）
```text
Agent (Client)
  └─ HTTP POST /detect (multipart/form-data + Bearer token)
        ↓
    FastAPI (main.py)
      ├─ Ultralytics YOLO11 推論
      ├─ バウンディングボックス描画
      └─ JSON + Base64 エンコード画像を返却
```

## 認証とセキュリティ
1. `.env` など安全なストレージに `API_KEY` を保持し、実行時にヘッダーへ適用します。
2. 通信経路を HTTPS で公開する場合は、リバースプロキシ（例: nginx）で TLS を終端してください。
3. エージェントが複数存在する場合は、キーを分離してローテーションできるようにします。

## リクエスト手順
| 手順 | 内容 |
| ---- | ---- |
| 1 | JPEG/PNG などの画像ファイルを取得する（最大サイズはインフラの制限に合わせる） |
| 2 | `Authorization: Bearer <API_KEY>` ヘッダーをセットする |
| 3 | `file` フィールドにバイナリを付与して `multipart/form-data` で `/detect` に POSTする |
| 4 | タイムアウトは 30〜60 秒を推奨（CPU 推論の場合） |

```bash
curl -X POST "http://127.0.0.1:8000/detect" \
     -H "Authorization: Bearer $API_KEY" \
     -F "file=@sample.jpg"
```

## レスポンスの扱い
```json
{
  "detections": [ { "label": "person", "confidence": 0.91, "box": [36.4, 52.8, 221.3, 309.9] } ],
  "counts": { "person": 1 },
  "image_with_boxes": "data:image/jpeg;base64,/9j/..."
}
```
- `detections`: ラベル、信頼度、座標を配列で保持。エージェント側でフィルタリングや集計が可能。
- `counts`: ラベルごとの出現数。しきい値判定に利用できます。
- `image_with_boxes`: バウンディングボックス入り画像（Base64 Data URI）。必要に応じてデコード。

## エラー処理
| ステータス | 原因 | エージェント側の対処 |
| --------- | ---- | ------------------ |
| 401 | APIキー不正 | キーの再読込、Secrets 管理設定を再確認 |
| 415 | ファイル形式不正 | JPEG/PNG のみを送信するよう前段処理を追加 |
| 500 | 推論中の例外 | リトライ（指数バックオフ）、ログを取得し再送 |

## 運用のヒント
- **バッチ処理**: 複数画像を扱う場合は、エージェント内でキュー制御し同時接続数を制限。
- **モデル切り替え**: `models/yolo11m.pt` を差し替える場合、再デプロイ前にウォームアップリクエストを送信。
- **監視**: リクエスト/レスポンス時間とエラー率をメトリクス化し、エージェントのリトライ閾値を動的に調整。

## 参照
- FastAPI ドキュメント: https://fastapi.tiangolo.com/
- Ultralytics YOLO: https://docs.ultralytics.com/
